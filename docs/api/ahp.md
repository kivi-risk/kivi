# 基于层次分析法（AHP）的信贷案例详解

> 风控初期冷启动情况，可采用层次分析法（AHP）。

## 理论

> 问题情景描述

某行开发一款针对工薪族的信贷产品，现需设计风控准入策略及模型，预测用户的借贷违约风险，但在业务初期没有表现数据，决定用AHP来确定客户的风险情况，以区分好客户和坏客户。

> 层次结构建立

建立风控策略及模型的目标是筛选出好客户进件放款。为达到这一目标，从客户的还款能力和还款意愿两个方面来考虑。还款能力主要看客户的基本信息、工作信息以及行内信息；还款意愿主要看客户的信用信息和三方信息。由此画出好客户筛选的层次结构图：

<center>
<img src="img/ahp/ahp_0.png" width="680px">
</center>

> 两两比较矩阵构造

为了比较下层对上层的相对重要性，构造两两比较矩阵。通常会邀请10-20个经验专家对同一层次内两两因素的相对重要性进行打分。根据准则层B各因素相对重要性对其进行打分，确定准则层B各因素对目标层A的相对重要性的权重（采用1-9标度法），如下表：

<center>
<img src="img/ahp/ahp_1.png" width="680px">
</center>

**注：**对角线数据为1（与自身对比）；标绿单元格代表，与B1相比，B2与其同等重要。

对称的标黄单元格，直接取倒数即可。

同理，根据领域层C各因素相对重要性对其进行打分，确定领域层C各因素对准则层B的相对重要性的权重，如下表：

<center>
<img src="img/ahp/ahp_3.png" width="680px">
</center>

同理，根据因子层D各因素相对重要性对其进行打分，确定因子层D各因素对领域层C的相对重要性的权重，如下表：

<center>
<img src="img/ahp/ahp_4.png" width="680px">
</center>


根据以上表格数据，计算各因子的总权重，**如下图：**

<center>
<img src="img/ahp/ahp_9.png" width="680px">
</center>

**注：**总权重是每层因子比重的乘积，如：学历的总权重$3.2 \\% = 0.5 \times 0.11 \times 0.59$。

**整理成表格形式如下：**

<center>
<img src="img/ahp/ahp_10.png" width="680px">
</center>

**注：**以上数据为虚构数据。通过表格可看出，在选取的评价一个客户的12个因素中，逾期次数最为重要，其次是月收入。

> 一致性检验

两两比较矩阵的元素是通过两个因素比较得到的，而在很多这样的比较中，往往可能得到一些不一致性的结论。例如，当因素**A、B、C**的重要性很接近的时候，在两两比较时，可能得出A比B重要，B比C重要，而C又比A重要等矛盾的结论，这在因素的数目多的时候更容易发生。 以信用信息下层的三个因素（**征信查询次数、本息逾期次数、信用卡使用情况**）为例：

**Step1：**由被检验的两两比较矩阵乘以其特征向量，所得的向量称之为赋权和向量

<center>
<img src="img/ahp/ahp_11.png" width="380px">
</center>

**Step2：**每个赋权和向量的分量分别除以对应的特征向量的分量

```text
1.81 / 0.59 = 3.05
0.76 / 0.25 = 3.05
0.48 / 0.16 = 3.05
```

**Step3：**计算出Step2结果中的平均值，记为$\lambda_{avg}$

$$ \lambda_{avg} = \frac{3.05+3.05+3.05}{3}=3.05 $$

**Step4：**计算一致性指标CI

$$CI = \frac{\lambda_{avg}-n}{n-1}$$
$$CI = \frac{3.05 – 3}{3 – 1} = 0.03$$

**Step5：**计算一致性率CR

$$CR = CI / RI = 0.03 / 0.58 = 0.05 < 0.1$$

即通过一致性检验。

**注：**RI的取值如下表:

<center>
<img src="img/ahp/ahp_12.png" width="680px">
</center>

*TIPS: 层次分析法是一种带有模拟人脑决策方式的方法，因此不可避免会带有很多定性色彩。随着机构业务规模的扩大，以及数据可信度的提高，会逐步采用比较“高深”的数学模型方法。*

## KIVI-AHP

[示例数据](https://github.com/kivi-risk/kivi/blob/master/test/data)

> 示例

```python
import pandas as pd
from kivi.ahp import AHP

metrix = pd.read_excel("ahp.xlsx", sheet_name="metrix")

ahp = AHP(metrix=metrix)
ahp.solve_metrix()
```

*log*

```text
[AHP] Metrix: <A> CR = 0.00
[AHP] Metrix: <B1> CR = 0.25 CR is too large, please check your metrix.
[AHP] Metrix: <B2> CR = 0.00
[AHP] Metrix: <C1> CR = 0.04
[AHP] Metrix: <C2> CR = 0.00
[AHP] Metrix: <C3> CR = 0.00
[AHP] Metrix: <C4> CR = 0.04
[AHP] Metrix: <C5> CR = 0.00
```

> 权重

```python
print(ahp.metrix_weight.get("C1"))
```

*输出*

```text
| experimental   |   geo_mean |   weight |
|:---------------|-----------:|---------:|
| 学历           |   2.08008  | 0.594442 |
| 年龄           |   0.548481 | 0.156744 |
| 性别           |   0.870659 | 0.248815 |
```

> CI-CR

```python
print(ahp.group_ci)
print(ahp.group_cr)
```

> 全量权重

```python
print(ahp.weight())
```

*输出*

```text
|    | dst            |   geo_mean |   group_weight |
|---:|:---------------|-----------:|---------------:|
|  0 | 还款意愿       |   1        |       0.5      |
|  1 | 还款能力       |   1        |       0.5      |
|  2 | 基本信息       |   0.404124 |       0.110239 |
|  3 | 工作信息       |   1.18167  |       0.322342 |
|  4 | 行内信息       |   2.08008  |       0.567418 |
|  5 | 三方信息       |   0.574456 |       0.249059 |
|  6 | 信用信息       |   1.73205  |       0.750941 |
|  7 | 学历           |   2.08008  |       0.594442 |
|  8 | 年龄           |   0.548481 |       0.156744 |
|  9 | 性别           |   0.870659 |       0.248815 |
| 10 | 月收入         |   1.41421  |       0.666667 |
| 11 | 职业           |   0.707107 |       0.333333 |
| 12 | 日均存款       |   0.574456 |       0.288865 |
| 13 | 未结清账户数   |   1.41421  |       0.711135 |
| 14 | 信用卡使用情况 |   0.548481 |       0.156744 |
| 15 | 征信查询次数   |   0.870659 |       0.248815 |
| 16 | 本息流期次数   |   2.08008  |       0.594442 |
| 17 | 手机年限       |   1.41421  |       0.666667 |
| 18 | 手机消费       |   0.707107 |       0.333333 |
```

## End

--------

- [基于层次分析法（AHP）的信贷案例详解](https://mp.weixin.qq.com/s/AUwnd3moPvkaDssCAODelA)