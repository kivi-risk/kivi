# 概率校准

> 模型校准主要涉及三个主要因素：主标尺、长期平均违约率和债务人评级分布。围绕这三个要素，模型校准的定义可描述为：模型校准是将债务人风险模型的结果对应到真实的违约概率，经过主标尺的映射得到债务人的风险评级。

## 1. 模型概率失准的来源

按照`logistic`回归模型的设计逻辑，一般认为模型输出的结果就是违约概率。但现实情况中，可能由于以下几种原因导致模型输出概率并不是主体真实的违约概率。

1. 由于正负样本的采样频率不同导致的模型输出概率与实际概率不一致。
2. 由于使用的模型方法不同，由模型特性导致的模型输出概率与实际概率不一致。
3. 由于测试样本与泛化样本之间的分布发生了变化，导致模型输出概率与实际概率不一致。
4. 由于模型算法的特性导致。

在实际业务场景中，涉及**分群评分卡**、**备用模型**、**客群变化修正**等具体业务场景时，也需要对风险进行同一校准。确保不同评分卡给出的分数（评级）具有相同的含义，提高预测概率与真实概率之间的一致性，修正实际概率和开发样本中期望概率之间的偏差。

## 2. 概率校准的三个方面

> 概率校准包括了样本校准、集中趋势校准、模型算法概率校准

### 2.1 样本校准

为了更精准的对应模型分值与实际违约概率，一般都需要进行模型校准；另，若模型纳入了一些定性指标或定性模块，在无法判断定性指标的违约分布的情况下，校准就更有必要了。

模型构建后一般可以获得模型的输出结果，这里一般指的是模型输出的分值。可以使用下式进行拟合

$$
ln(\frac{PD}{1-PD}) = \alpha + \beta \times Score
$$

如下图所示，黑线即为违约概率曲线

![Image](https://pic4.zhimg.com/80/v2-eaf856c54d970b6235a51dbdcc6ae26e.png)

### 2.2 集中趋势校准

由于建模样本和总体样本的平均违约概率不一致，还需要进行集中趋势校准。

从《新资本协议》的监管稳健性要求出发，模型的结果应该校准到多年样本总体的平均违约概率，集中趋势校准的基本思想可以用下式表达：

$$
PD_{校准} = PD \times \frac{多年总体样本历史平均违约率}{建模样本历史平均违约率}
$$

也有理论认为，从模型应用的角度，模型违约概率应该是向前看的预测违约概率，则集中趋势校准的基本思想可以用下式表达：

$$
PD_{校准} = PD \times \frac{预期总体样本平均违约率}{建模样本历史平均违约率}
$$

`logistic` 回归模型 $ln(\frac{PD}{1-PD}) = \alpha + \beta X^{T}$ 中，评级结果的排序结果是由自变量的系数向量 $\beta$ 决定，集中趋势则由常数项 $\alpha$ 决定，则集中趋势校准可以调整常数
项 $\alpha$ 得到:

$$
ln(\frac{PD}{1-PD}) = \alpha' + \beta X^T
$$

### 2.3 模型算法概率校准

在机器学习模型实践应用中，我们主要关注分类模型的排序性(ranking)。这就引出了校准(calibration)的概念，即预测分布和真实分布（观测）在统计上的一致性。由于我们无法获知真实的条件概率，通常用观测样本的标签来统计代替，并用可靠性曲线图(`Reliability Curve Diagrams`)来直观展示当前模型的输出结果与真实结果有多大偏差。如下图所示:

![概率校准可靠性曲线](https://scikit-learn.org/stable/_images/sphx_glr_plot_compare_calibration_001.png)

横坐标为事件发生预测概率，纵坐标为事件发生实际频率，展示`某个事件预测概率 VS 实际发生的频率`之间的关系。对于一个理想的预测系统，两者是完全一致的，也就是对角线。

从上图中可以看出，逻辑回归基本近似真实概率，而其他模型的输出并不是真实概率的近似。因此使用逻辑回归外的其他分类器的输出评分卡（评级）概率，远远不能认为是真实概率的近似，需要进一步的转换。

## 3. 主标尺

商业银行一般将评分（评级模型）违约概率映射到同一的违约概率主标尺。

### 3.1 主标尺设计基本原则

主标尺划分的关键点在于结合银行资产组合的风险特征和评级业务的实践，建立覆盖所有资产组合的风险评级和量化的映射关系，使其具备风险评级的精确性和稳定性。通过统计模型可以计算得到每个客户的违约概率（$PD$），客观地表征客户的风险程度。所谓主标尺是指提供合理的 $PD$ 划分区间，把所有客户划分为若干个区间，并定义区间对应的信用评级，即设定一个能够区分客户风险程度、便于客户差别化管理且符合监管要求的全行统一的违约概率和信用等级对应的标准尺度。信用评级主标尺设定的基本原则是客观性、独立性、稳定性和时效性：

1. 客观性：指主标尺只是违约概率与信用等级之间客观对应；
2. 独立性：指不同银行的主标尺可以不同；
3. 稳定性：指主标尺不宜频繁变动；
4. 时效性：指随着环境和客户群的变化，主标尺要进行适当的跟进修正。

另，设立主标尺还要考虑如下因素：

1. 满足监管当局监管指引的要求，银监会《商业银行信用风险内部评级体系监管指引》相关规定。
1. 不同级别之间要具有区分度，即不同级别的违约概率差异不能太小，不同级别应该代表不同的违约风险客户群，以达到风险区分的目的。
1. 不同级别的违约概率差异不能太大，以避免风险不够细分。
1. 客户在各个级别之间具有合理的分布，以达到客户差异化管理的目的。
1. 满足银行内部管理的要求，如某个级别以上的客户不能少于一定的百分比，某个级别以上的客户不能多于一定的百分比。
1. 能够与国际公认的评级机构的级别相对应，以便于同行进行比较和资产管理。

*《商业银行信用风险内部评级体系监管指引》相关规定：*

**第二十八条** 商业银行应设定足够的债务人级别和债项级别，确保对信用风险的有效区分。信用风险暴露应在不同债务人级别和债项级别之间合理分布，不能过于集中。

**第二十九条** 商业银行债务人评级应最少具备 `7` 个非违约级别、`1`个违约级别，并保证较高级别的风险小于较低级别的风险。根据资产组合的特点和风险管理需要，商业银行可以设定高于本指引规定的债务人级别，但应保持风险级别间排序的一致性和稳定性。

**第三十条** 若单个债务人级别风险暴露超过所有级别风险暴露总量的 30% ，商业银行应有经验数据向监管部门证明该级别违约概率区间合理并且较窄，该级别中所有债务人的违约概率都在该区间内。

### 3.2 主标尺概念界定

银行主标尺是指由字母或数字组成的、对应相应违约概率区间的评级标识，主要用于反映客户不同信用风险水平的工具。 构成主标尺的基本要素包括评级标识以及对应违约概率（Probability of Default）上限值、下限值和中点值。一般来说，每个评级标识还有相应信用风险的定性描述。

![主标尺概率区间](https://pic4.zhimg.com/80/v2-bf8a991156e95ff084d19e67abda2efe.png)

### 3.3 主标尺开发流程

![主标尺开发流程](https://pic4.zhimg.com/80/v2-cfc36b2c1e90727118b7b441a58b62a5.png)

- 第一步，通过分析历史样本数据，开发定量模型，得到企业信用状况的模型评分；基于评分结果，对开发样本中各个企业的信用风险状况高低进行排序。

- 第二步，对第一步生成的模型评分进行校准，校准过程需要盯住该类型客户长期违约的中心趋势；完成校准后，得到每个企业的违约概率值。

- 第三步，通过将每个生成的违约概率值对应到主标尺的评级区间，得到企业的初始信用评级结果，再通过评级调整和评级推翻，最终得到经过认定的企业评级终审结果，以及对应的该级别违约概率中点值。

## 4. 模型校准的方法

### 4.1 模型校准基本步骤

1. 确定各个评级占比及对应的得分区间；
2. 统计落入各个评级的客户数及违约数；
3. 二项检验；
4. 计算校准后的实际违约率。

### 4.2 具体实施

暂略

## 5. 考虑当前概率校准工作安排

### 5.1 各规模、行业、地区违约中心趋势测定

#### 5.1.1 整体小微违约趋势

#### 5.1.2 分客群违约趋势

规模考虑以下三类：
1. 大、大中、中
2. 小、微、疑似小微
3. 未知

行业考虑：批发、零售、制造业、建筑业，等。

地区考虑：浙江、广东、上海、江苏、山东，等。

### 5.2 主标尺开发

### 5.3 模型的概率校准

### 5.4 疑点、难点

1. 不确定各银行的违约、关注、不良的口径是否一致

------

> 其他参考文章：

- [1] Predicting Good Probabilities with Supervised Learning, A. Niculescu-Mizil & R. Caruana, ICML 2005
- [2] [Reliability diagrams](https://www.cnblogs.com/downtjs/p/3433021.html)
- [3] [使用 Isotonic Regression 校准分类器](https://vividfree.github.io/%25E6%259C%25BA%25E5%2599%25A8%25E5%25AD%25A6%25E4%25B9%25A0/2015/12/21/classifier-calibration-with-isotonic-regression)
- [4] Alexandru Niculescu-Mizil, et al. Predicting Good Probabilities With Supervised Learning. ICML2005.
- [5] [信用评分卡模型分数校准](https://zhuanlan.zhihu.com/p/82670834)
- [6] Gary King, Langche Zeng. Logistic Regression in Rare Events Data. Political Methodology. 2002
- [7] [Calibrating Probability with Undersampling for Unbalanced Classification](www3.nd.edu/~rjohns15/content/papers/ssci2015_calibrating.pdf)
- [8] ["SAS"-Oversampling](www.data-mining-blog.com/tips-and-tutorials/overrepresentation-oversampling/)
- [9] [面向稀有事件的 Logistic Regression 模型校准](vividfree.github.io/%25E6%259C%25BA%25E5%2599%25A8%25E5%25AD%25A6%25E4%25B9%25A0/2015/12/15/model-calibration-for-logistic-regression-in-rare-events-data)
