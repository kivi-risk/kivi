### 1. 样本构建

> 模型要解决的业务目的不同，样本的构建也会有较大的区别，本篇仅简单介绍一下违约概率模型（PD模型）样本建设
> 需要注意的一些问题；这包含了贷前、贷中违约概率预测两个阶段。

> [样本相关代码](./descriptive_statistics/data_analysis?id=_5-%e6%a0%b7%e6%9c%ac%e7%a9%ba%e9%97%b4)

#### 1.1 客群条件

样本的构建，应该充分考虑不同的客群下、不同的信贷产品下由于企业经营模式的不同，
用信过程的不同而导致数据不同；为此，在构建样本时应区分不同的细分客群，使得数据
可以充分的表征该客群的经营模式与信用风险，从而使得构建的模型效果更好。

> 客户维度考虑：

客户的规模、行业、地区等。

> 信贷产品维度考虑：

信贷产品的贷款类型、额度范围、还款方式、担保类型、信贷周期等。

> 其他维度考虑：

若发现在其他维度上体现出了数据异质性，则需要考虑在该维度上进行切分样本。

#### 1.2 目标标签的定义

> 一般目标标签的选择

- 五级分类：正常、关注、次级、可疑、损失。一般地次级类、可疑类、损失类为不良贷款。`关注`类的样本是否可以
定义为不良，是一个值得进一步考虑的事情，可以计算`关注`到`后三类（次级类、可疑类、损失类）`的转换率，如果
转换率高也可以将`关注`放入不良；当然，如果犹豫不决`关注`也可以列为灰客户。
- 其他维度的违约标签：逾期天数、利息逾期等。按照逾期天数定义违约，应进行一定的滚动率分析（如，Vintage），
确定违约的逾期界限，一般经验定义在30d至60d，也有定义在90d。

> 观察时点标签与表现期结束时点标签

1. 违约概率模型：预测好客户未来变坏的可能性，观察时点标签（G/Null）表现期结束时点标签(M/B)。
2. 灰/坏客户捞回：预测坏/灰客户变好的可能性，观察时点标签（M/B）表现期结束时点标签(G)。

#### 1.3 样本基本信息

为便于样本的分析，应考虑在样本空间上补充必要的样本基本信息。考虑如下：

1. 违约标签：观察时点的违约状态，表现期结束时点的违约状态等。
2. 客户信息：行业、规模、地区等。
3. 信贷信息：合同额度，担保方式等。

#### 1.5 其他考虑

1. 表现期不足，导致客户量极少，不足以支撑建模。可以考虑提前还款的好客户，提前发现违约的坏客户，或者放低违约标签的标准，
将逾期客户纳入违约、将利息逾期客户纳入违约。
2. ... ... 

### 2. 样本分析

样本的分析重点在以下几个方面：

1. 样本量是否足够支撑建模，坏客户量是否足够支撑有监督建模。
2. 样本的在各种维度上是否符合预期，在时间上是否稳定，论证当前样本可以在很大程度上代表未来的客群。
3. 样本的违约标签定义是否合理，滚动率是否正常，论证当前的违约标签定义是合理的是能够体现风险排序的。
4. 样本的观察期是否足够。

#### 2.1 一般基本分析

> 样本量检查：

**时间维度**：各月客户的样本量、唯一性、坏客户数、违约率等。

```sql
-- SQL 示例
SELECT load_date                               -- 样本日期
    , count(uuid) AS uuid                      -- 样本量   
    , count(DISTINCT uuid) AS dist_uuid        -- 不同客户样本量
    , sum(target) AS bad                       -- 坏客户数量
    , avg(target) AS bad_rate                  -- 坏客户率        
FROM {db_name}.{table_name_sample}             -- 样本表或样本空间表
GROUP BY load_date
ORDER BY load_date
```

注意，检查目的如下：

1. 各月样本量是否平稳一致，没有太大起伏，样本量突变是否业务可解释；一般认为样本突变`30%`以上要引起注意。
2. 样本如果是按月聚合，要看各月在各聚合日期下是否有重复的，一般不可能有重复的，如果有则需要分析代码是否正确。
3. 各月坏客户量是否足够，最少需要`30`个坏客户，最好能有`100`个坏客户。
4. 各月违约率是否平稳可解释，如果违约率浮动超过`30%`也需要引起注意。
5. 在时间维度上能否切分出足量有效的`OOT`样本进行模型的检验。

**客群维度**：规模、行业等。

```sql
-- SQL 示例
SELECT {scope/industry/zone}                    -- 规模、行业、地区
    , count(uuid) AS uuid                       -- 样本量   
    , count(DISTINCT uuid) AS dist_uuid         -- 不同客户样本量
    , sum(target) AS bad                        -- 坏客户数量
    , avg(target) AS bad_rate                   -- 坏客户率        
FROM {db_name}.{table_name_sample}              -- 样本表或样本空间表
GROUP BY {scope/industry/zone}
ORDER BY {scope/industry/zone}
```

注意，检查目的如下：

1. 一般认为违约率：`微 > 小 > 中 > 大`。
2. 各行业、地区违约率是否符合业务认知；某些行业、地区可能因为数据量过少而不准确。

#### 2.2 表现充足分析

> 在不同周期的信贷场景下，模型的预测周期也是不同的，应分析模型所定义的表现期是否能够充分观察到主体的表现状态。

检验基本操作步骤如下：

1. 构建不同表现期长度的样本空间。
2. 统计不同表现期长度样本空间的`B To G`转换率。
3. 分析，一般随着表现期长度的增加，违约转换率增加，直至转换率不变，转化率维持不变的表现期长度即为样本应设定的表现期。

*一般地，一年期的信贷产品，表现期在合同签订后14至15月时好坏转换率就保持稳定了，稳健起见定16个月的表现期一般是合理的。*

#### 2.3 不良状态转化分析

> 分析违约标签定义是否准确。

至少应统计如下内容：

1. 不良 To 不良
2. 关注 To 不良
3. 逾期 To 不良

*一般地，以上统计转换率应逐步降低。可能的情况下，还应统计以上转化是否在时间上是稳定的。*

#### 2.4 其他维度的样本分析

1. 交叉维度的稳定性：`时间.规模`、`时间.行业`、`行业.规模`、`其他`。
2. 通过些重点字段的分布分析，判断样本的稳定程度。如：总资产、年收入、员工人数、纳税等

### 3. 样本存储

> **样本空间**至少包含（UID/违约标签/日期），如有必要可以加入（主体的规模、行业、授信额等）。

> **样本指标**

1. 建模样本一般指的是在样本空间上匹配上相应的指标，构成样本大宽表，以便数据的分析与模型的拟合。
2. 样本指标匹配会包含两张表，一张表为样本长表方便增删指标，一张表为样本宽表为样本长表装换而来。

### 4. 全量最新客群的评分

#### 4.1 全量最新客群选取

1. 依据实际业务需要选择要计算的客群`UID`。
2. 客群`UID`的子模型计算标签。该标签标定`UID`需要计算的子模型模块，部分主体由于数据的缺失不能满足某些子模型
的计算，在计算子模型的阶段需要将此类的客户通过子模型标签进行标定，实际子模型计算时不纳入该部分的客户。

#### 4.2 评分计算

> 评分计算参数信息，应至少包含以下：

1. 各子模型的指标分数转换参数，依据该参数选择全量客户的指标信息，以及将指标映射至指标分数。
2. 子模型的权重参数，依据该参数将子模型指标加权汇总至子模型分。
3. 总模型的权重参数，依据该权重将子模型分数加权汇总至总模型分。
4. 子模型空值赋分参数，用于对无法计算子模型分数的情况对子模型分数进行填充。
5. 其他分数调整参数，用于特殊情况的评分调整，如对观察时点不良主体调低分等。

> 简要评分计算

1. 指标分数映射

$$
index\ score_i = f(index\ value_i) \tag{1}
$$

2. 子模型分数计算

$$
module\ score = (index\ score_i)^T\ module\ weight_i \tag{2}
$$

3. 总模型分数计算

$$
model\ score = (module\ score_i)^T\ model\ weight_i \tag{3}
$$

#### 4.3 评分保存

> 指标分数保存

|名称   |示例  |
|------|:-----|
|客户UID|-     |
|指标名称|I10101001|
|指标分数|0-100分|
|时间日期（分区字段）|20200131|

> 模型分数保存

|字段|	中文名|
|----|----|
|uuid|	唯一标识	|
|account|	存款流水子模型分数	|
|liab|	负债子模型分数	|
|glr|	关联人子模型分数	|
|finance|	融资子模型分数	|
|account_t|	存款流水子模型评分标签	|
|liab_t|	负债子模型评分标签	|
|glr_t|	关联人子模型评分标签	|
|finance_t|	过去一年中企业是否存在融资行为	|
|finance_curr_t|	融资子模型评分标签	|
|score|	模型总分	|
|load_date|	评价日期	|

#### 4.4 总体评分的分析

1. 总体分数的分布，应注意总体评分的分布是否与样本评分的分布是否一致，差异过大应进一步分析原因。
2. 总体分数的通过率，应注意在总体分数通过率与样本上的通过率的差异。
3. 总体分数的波动，应注意总体分数在时间段上的迁徙，应做分数（评级）的迁徙分析，应避免主体在不同的时间上评价结果差异过大。
4. 特殊客群的监控，应注意一些特殊客群的分数（如，观察时点的坏客户、灰客户、扣分项的客户）。
5. 总体评分的分析，不仅应当注意模型的最终结果，更应当关注整个评分的出的过程，需要关注主体的子模型分数、指标分数、扣分项等，
始终关注模型分数的得出是否符合业务的含义，是否有解释不清楚的微观个体。

#### 4.4 其他信息保存

> 准入、反欺诈规则信息，表结构：

|名称   |示例  |
|------|:-----|
|客户UID|-     |
|规则名称|规则集1、子规则明细|
|规则结论|0通过、1拒绝|
|模块（分区字段）   |准入、反欺诈|
|时间日期（分区字段）|20200131|

> 被拒绝客户的信息

被拒绝客户的信息应包含以下三类：

1. 准入拒绝客户的信息
1. 反欺诈拒绝客户的信息
1. 评分卡拒绝客户的信息

用于：

1. 拒绝推断、模型改进。
2. 拒绝客户捞回。
3. 客群细分、市场下沉、次级贷、业务拓展等。

----
