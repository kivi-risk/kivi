# æ ·æœ¬åŠ æƒåˆ†ç®±åˆ†æ

## åŠ æƒåˆ†ç®±çš„åŸºæœ¬æ€æƒ³

> æ¨¡å‹è¿­ä»£å¯¼è‡´çš„ä¸€äº›é—®é¢˜ï¼š

1. **æ¨¡å‹è¿­ä»£å¯¼è‡´æ ·æœ¬æœ‰å**ã€‚åœ¨æ¨¡å‹çš„è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œä¸šåŠ¡ä¸Šä¼šä¸æ–­æ‹’ç»ç»¼åˆå†³ç­–ä¸é€šè¿‡çš„å®¢æˆ·ï¼Œå¯¼è‡´éšç€ä¿¡è´·ä¸šåŠ¡çš„å¼€å±•åç»­çš„å…¥æ¨¡æ ·æœ¬æ˜¯æœ‰åçš„ï¼ˆç¼ºå¤±äº†æ‹’ç»å®¢æˆ·çš„ä¿¡è´·è¡¨ç°ï¼‰ã€‚
2. **æœ‰åæ ·æœ¬å¯¼è‡´åˆ†ç®±å¤±å‡†**ã€‚åœ¨æœ‰åçš„æ ·æœ¬ä¸Šè¿›è¡Œåˆ†ç®±çš„åˆ†æï¼Œå¯èƒ½ä¼šå¯¼è‡´åˆ†ç®±çš„æˆªæ–­ç‚¹æœ‰åï¼Œä¸¥é‡æ—¶å¯èƒ½ä¼šå¯¼è‡´ä¹‹å‰æœ‰æ•ˆæŒ‡æ ‡çš„å¤±æ•ˆã€‚

> åŠ æƒåˆ†ç®±çš„åŸºæœ¬æ€æƒ³ï¼š

1. åœ¨`KGBæ ·æœ¬`ä¸­åŠ å…¥`IGBæ ·æœ¬`ï¼Œä½†æ˜¯åœ¨å…·ä½“è®¡ç®—åˆ†ç®±æˆªæ–­ç‚¹æ—¶ï¼Œåˆ†åˆ«è€ƒè™‘ä¸¤ç±»æ ·æœ¬çš„æƒé‡ã€‚
2. åœ¨è®¡ç®—åˆ†ç®±çš„`WOE`æ—¶ï¼Œéœ€è¦ç»Ÿè®¡å„ä¸ªåˆ†ç®±çš„å¥½åå®¢æˆ·é‡ï¼Œè¿™æ—¶ä¹Ÿåˆ†åˆ«è€ƒè™‘ä¸¤ç±»æ ·æœ¬å¯¹äºå¥½åå®¢æˆ·é‡çš„è´¡çŒ®ã€‚
3. æ€»ä½“æ¥è¯´ï¼ŒåŠ æƒåˆ†ç®±æ–¹æ³•è€ƒè™‘äº†`IGBæ ·æœ¬`ä¸€å®šçš„æ•°æ®åˆ†å¸ƒç‰¹æ€§ï¼Œè¡¥å……åœ¨`KGBæ ·æœ¬`ä¸Šï¼Œä»ä¸€å®šç¨‹åº¦ä¸Šé™ä½äº†æ ·æœ¬çš„åç¦»ç¨‹åº¦ï¼Œå¤åŸäº†æ ·æœ¬çš„æ€»ä½“æƒ…å†µï¼Œä»è€Œä½¿å¾—åˆ†ç®±æ›´å…·é²æ£’æ€§ã€‚

*æ³¨ï¼š`KGB`æŒ‡çš„æ˜¯å·²çŸ¥æ ‡ç­¾çš„æ ·æœ¬ï¼Œå³æ”¾æ¬¾çš„å®¢ç¾¤ã€‚`IGB`ä¸ºæœªçŸ¥æ ‡ç­¾çš„å®¢ç¾¤ï¼Œå³æœªæ”¾æ¬¾çš„å®¢ç¾¤ã€‚*

## åŠ æƒåˆ†ç®±çš„åŸºæœ¬åšæ³•

> ä¾æ®æ‹’ç»å®¢æˆ·è¿›è¡ŒåŠ æƒåˆ†ç®±ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

- `Step 1`: åœ¨**KGBæ ·æœ¬**ä¸Šè¿›è¡Œè‡ªåŠ¨åŒ–å†³ç­–æ ‘åˆ†ç®±ï¼Œä¾æ®åˆ†ç®±è½¬æ¢æŒ‡æ ‡å€¼ä¸º`WOE`å€¼ï¼Œå¹¶ä¾æ®`WOE`å€¼åšä¸€ä¸ª`logistic`æ¨¡å‹ã€‚
- `Step 2`: åœ¨**IGBæ ·æœ¬**ä¸Šä½¿ç”¨`Step 1`æ¨¡å‹è¿›è¡Œ`PD`è®¡ç®—ï¼Œä»¥`PD`å€¼ä¸º**IGBæ ·æœ¬**çš„æƒé‡ï¼›å¤åˆ¶ä¸€ä»½**IGBæ ·æœ¬**å¹¶ä»¥`1 - PD`ä¸ºæƒé‡ã€‚
- `Step 3`: åœ¨**KGBæ ·æœ¬**ä»¥`1`ä¸ºæ ·æœ¬æƒé‡ï¼Œå¹¶ç»„åˆä¸¤ä¸ª**IGBæ ·æœ¬**ä¸ä¸€ä¸ª**KGBæ ·æœ¬**ï¼Œå…±åŒæ„æˆæ–°çš„æ ·æœ¬ã€‚
- `Stpe 4`: åœ¨æ–°æ ·æœ¬ä¸Šï¼Œè¿›è¡Œæ ·æœ¬åŠ æƒå†³ç­–æ ‘åˆ†ç±»ï¼Œå¾—åˆ°åˆ†ç®±çš„æˆªæ–­ç‚¹ã€‚
- `Step 5`: åœ¨`Stpe 4`çš„åˆ†ç®±æˆªæ–­ç‚¹çš„åŸºç¡€ä¸Šï¼Œè¿›è¡Œ`WOE/IV`çš„è®¡ç®—ã€‚å…¶ä¸­å¥½å®¢æˆ·ã€åå®¢æˆ·çš„è®¡ç®—ä»¥åŠ æƒæ±‚å’Œæ–¹å¼è¿›è¡Œã€‚

$$
\sum_{bucket} good = \sum_{bucket} weight_i \times good_i
$$

$$
\sum_{bucket} bad = \sum_{bucket} weight_i \times bad_i
$$

## å®ç°

### Step 1: æ ·æœ¬çš„åˆ’åˆ†

```python
import numpy as np
import pandas as pd
from kivi.woe import *
from kivi.datasets import *
from kivi.utils.operator import *

# ä¸ªäººä¿¡è´·è¿çº¦æ•°æ®é›†
df_bank = Dataset.bank_data()

# æ ·æœ¬é‡åˆ’åˆ†
good = (df_bank.target.count() - df_bank.target.sum())
bad = df_bank.target.sum()
n_good = int(good * 0.7)
n_bad = int(bad * 0.7)

# KGB é€šè¿‡å†³ç­–çš„æ ·æœ¬ï¼Œå¥½å®¢æˆ·å æ€»é‡ 70% åå®¢æˆ·å æ€»é‡çš„ 30%
df_kgb_good = df_bank[df_bank.target == 0][: n_good]
df_kgb_bad = df_bank[df_bank.target == 1][n_bad: ]
df_kgb = df_kgb_good.append(df_kgb_bad)

# IGB æœªé€šè¿‡å†³ç­–çš„æ ·æœ¬ï¼Œå¥½å®¢æˆ·å æ€»é‡ 30% åå®¢æˆ·å æ€»é‡çš„ 70%
df_rej_good = df_bank[df_bank.target == 0][n_good: ]
df_rej_bad = df_bank[df_bank.target == 1][: n_bad]
df_rej = df_rej_good.append(df_rej_bad)

print(f'å·²é€šè¿‡æ ·æœ¬ï¼š{df_kgb.shape} è¿çº¦ç‡ï¼š{df_kgb.target.mean():.3f}')
print(f'æœªé€šè¿‡æ ·æœ¬ï¼š{df_rej.shape} è¿çº¦ç‡ï¼š{df_rej.target.mean():.3f}')

# é€‰æ‹©æ•°å€¼å‹å˜é‡
columns = ['campaign', 'duration', 'previous', 'age', 'balance']
df_kgb['uuid'] = np.arange(0, len(df_kgb))
df_kgb = df_kgb[columns + ['target', 'uuid']].copy()
df_rej['uuid'] = np.arange(1e4, 1e4+len(df_rej))
df_rej = df_rej[columns + ['target', 'uuid']].copy()
```

*è¾“å‡º*

```text
å·²é€šè¿‡æ ·æœ¬ï¼š(2957, 17) è¿çº¦ç‡ï¼š0.053
æœªé€šè¿‡æ ·æœ¬ï¼š(1564, 17) è¿çº¦ç‡ï¼š0.233
```

### Step 2: åœ¨`KGB`ä¸Šè¿›è¡Œåˆ†ç®±ï¼Œå¹¶è¿›è¡Œ`KGB`æ¨¡å‹æ‹Ÿåˆ

```python
# åœ¨`KGB`ä¸Šè¿›è¡Œåˆ†ç®±ï¼Œå¹¶å°†æ•°æ®è½¬æ¢ä¸ºæŒ‡æ ‡åˆ†æ•°
batch = WOEBatch(df_kgb, max_bin=5, min_bin=2)
df_woe = batch.woe_batch_with_rebin()

woe_score = WOEScore(df=df_kgb, df_woe=df_woe, batch_size=3, verbose=False)
df_woeval = woe_score.batch_run()

# `KGB`æ¨¡å‹æ‹Ÿåˆ
model = StatsLogit(df_woeval[columns], df_woeval.target)
metrics = RocAucKs(df_woeval.target, model.predict())
print(f"KS = {metrics.get('ks'): .3f}, AUC = {metrics.get('auc'): .3f}")
```

*è¾“å‡º*

```text
KS =  0.629, AUC =  0.870
```

### Step 3: æ ·æœ¬æƒé‡è®¡ç®—ï¼Œä»¥åŠæ‹¼æ¥æ ·æœ¬

```python
# åœ¨`KGB`æ ·æœ¬ä¸Šï¼Œæ ·æœ¬æƒé‡éƒ½æ˜¯ 1
df_kgb['pd'] = 1

# ä½¿ç”¨ä¸Šé¢æ‹Ÿåˆçš„ `KGB` æ¨¡å‹å¯¹ `IGB` æ ·æœ¬è¿›è¡Œ `PD` æ‹Ÿåˆ
score = WOEScore(df=df_rej, df_woe=df_woe, batch_size=3, verbose=False)
df_woeval_rej = score.batch_run()
rej_predict = model.predict(sm.add_constant(df_woeval_rej[columns]))
df_rej['pd'] = rej_predict.tolist()

# æƒé‡ä¸º 1-PD çš„ `IGB` æ ·æœ¬
df_rej_a = df_rej.copy()
df_rej_b = df_rej.copy()
df_rej_a.target = 1
df_rej_b.target = 0
df_rej_b.pd = 1 - df_rej_b.pd
df_rej_b.uuid = df_rej_b.uuid + 3e4

# ç»„åˆ `IGB` å’Œ `KGB` æˆä¸ºæ–°çš„æœ‰æƒé‡çš„æ ·æœ¬
df_rej_new = df_rej_a.append(df_rej_b)
df_data = df_rej_new.append(df_kgb)
df_data.reset_index(drop=True, inplace=True)
```

### Step 4: è¿›è¡ŒåŠ æƒåˆ†ç®±

```python
# åŠ æƒåˆ†ç®±
batch = WOEBatch(
    df_data, max_bin=5, min_bin=2, 
    protect_columns=['uuid', 'target', 'pd'],
    dtc_weight=df_data.pd, weight=df_data.pd
)
df_woe = batch.woe_batch_with_rebin()

# ä½¿ç”¨åŠ æƒåˆ†ç®±ï¼Œå°† KGB æ ·æœ¬æŒ‡æ ‡è½¬æ¢ä¸ºæŒ‡æ ‡åˆ†æ•°
woe_score = WOEScore(df=df_kgb, df_woe=df_woe, batch_size=3, verbose=False)
df_woeval = woe_score.batch_run()
```

### Step 5: æ¨¡å‹æ‹Ÿåˆï¼Œæ•ˆæœè¯„ä¼°

```python
# æ–°çš„ KGB æ ·æœ¬æ¨¡å‹æ‹Ÿåˆ
model = StatsLogit(df_woeval[columns], df_woeval.target)

# æ¨¡å‹è¯„ä¼°
metrics = RocAucKs(df_woeval.target, model.predict())
print(f"KS = {metrics.get('ks'): .3f}, AUC = {metrics.get('auc'): .3f}")
```

*è¾“å‡º*

```text
KS =  0.629, AUC =  0.871
```

## åŠ æƒåˆ†ç®±çš„ç»“æœå¯¹æ¯”

> åˆ†ç®±ç»“æœå¯¹æ¯”

*åœ¨ `KGBæ ·æœ¬` ä¸Šæ‹Ÿåˆæˆªæ–­ç‚¹ï¼Œåœ¨å…¨é‡æ ·æœ¬ä¸Šåˆ†ç®±è¯„ä¼°å¯¹æ¯”ï¼šæŒ‡æ ‡`IV`ç”±`KGB`æ ·æœ¬çš„`1.820`åˆ°å…¨é‡æ ·æœ¬`1.833`ã€‚*

<img src="./img/woe_dtc_weight_0.png">

*åœ¨ `KGBæ ·æœ¬` ä¸Šæ‹Ÿåˆæˆªæ–­ç‚¹ï¼Œå¹¶è¿›è¡Œæƒé‡ä¿®æ­£ï¼Œç„¶ååœ¨å…¨é‡æ ·æœ¬ä¸Šåˆ†ç®±è¯„ä¼°å¯¹æ¯”ï¼šæŒ‡æ ‡`IV`ç”±æƒé‡ä¿®æ­£çš„`1.803`æå‡åˆ°å…¨é‡æ ·æœ¬`1.839`ã€‚*

<img src="./img/woe_dtc_weight_1.png">

**å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ ·æœ¬ä¸Šï¼Œä¿®æ­£åçš„æ ·æœ¬`IV`ä½äºæƒé‡ä¿®æ­£å‰ï¼Œä½†æ˜¯åœ¨å…¨é‡æ ·æœ¬ä¸Šï¼Œä¿®æ­£å`IV`ä¼šæ›´é«˜ã€‚**

> æ¨¡å‹ç»“æœå¯¹æ¯”

1. åŠ æƒä¿®æ­£å‰ï¼šKS = 0.629, AUC = 0.870
2. åŠ æƒä¿®æ­£åï¼šKS = 0.629, AUC = 0.871
3. ä¸Šé¢çš„è¿‡ç¨‹åªæ˜¯ä¸ªç¤ºä¾‹ï¼Œå®é™…ä¸Šä¸Šè¿°çš„æ ·æœ¬`IGBæ ·æœ¬` ä¸ `KGBæ ·æœ¬`æºäºåŒä¸€ä¸ªæ ·æœ¬ä¸”æ•°æ®é‡ç›¸å¯¹è¾ƒå°‘ï¼Œå¯ä»¥çœ‹åˆ°åŠ æƒä¿®æ­£åï¼Œæ¨¡å‹ç•¥æœ‰æå‡ã€‚
4. å¯ä»¥é¢„æœŸï¼Œåœ¨`IGBæ ·æœ¬` ä¸ `KGBæ ·æœ¬`å·®å¼‚æ›´å¤§åœ¨çš„å¤§æ ·æœ¬ä¸Šï¼Œä¿®æ­£åçš„åˆ†ç®±æˆªæ–­ç‚¹æ›´æ¥è¿‘å…¨é‡æ ·æœ¬çš„åˆ†ç®±æˆªæ–­ç‚¹ï¼Œä»è€Œä½¿å¾—ç¨³å®šæ€§å’Œæœ‰æ•ˆæ€§ç•¥ä¼˜äºæƒé‡ä¼˜åŒ–å‰ã€‚

> æˆå› åˆ†æ

**å¦‚ä¸‹å›¾ï¼Œåœ¨å€¼åŸŸè¾ƒå¤§çš„`bucket`ä¸­ï¼Œæƒé‡ä¿®æ­£åæœ‰æ›´é«˜çš„è¿çº¦ç‡ï¼Œä¹Ÿå°±ä¸€å®šç¨‹åº¦ä¸Šæé«˜äº†æŒ‡æ ‡çš„åŒºåˆ†èƒ½åŠ›ã€‚**

```python
(df_woe_wt.bad_rate - df_woe_wt_origin.bad_rate).abs().plot(label='wt')
(df_woe_kgb.bad_rate - df_woe_kgb_origin.bad_rate).abs().plot(label='kgb')
plt.legend()
```

<img src="./img/woe_weight_compare.png">

> å»ºè®®çš„å»ºæ¨¡ä¸€èˆ¬æ“ä½œ

1. æŒ‰ç…§é€šå¸¸æ­¥éª¤é€‰æ‹©æŒ‡æ ‡å»ºæ¨¡ã€‚
2. æŒ‰ç…§ä¸Šè¿°æ“ä½œé‡æ–°ä¼˜åŒ–æŒ‡æ ‡çš„åˆ†ç®±æˆªæ–­ç‚¹ã€‚
3. é‡æ–°æ‹Ÿåˆæ¨¡å‹å‚æ•°ã€‚

*æ³¨æ„ï¼šåœ¨å®é™…ä¸šåŠ¡å¼€å±•è¿‡ç¨‹ä¸­ï¼Œåº”ä¿å­˜æœªé€šè¿‡å®¢æˆ·çš„å„ç±»ä¿¡æ¯ï¼Œç”¨ä»¥å¤åŸ`IGBæ ·æœ¬`ã€‚*

----

> ğŸ“š Reference

- [1] [é£æ§æ¨¡å‹â€”ç¾¤ä½“ç¨³å®šæ€§æŒ‡æ ‡(PSI)æ·±å…¥ç†è§£åº”ç”¨](https://zhuanlan.zhihu.com/p/79682292)
- [2] [è¯„åˆ†å¡æ¨¡å‹ç›‘æ§ï¼ˆä¸€ï¼‰PSI & CSI](https://zhuanlan.zhihu.com/p/94619990)
- [3] [Scorecard-Bundle](https://github.com/Lantianzz/Scorecard-Bundle)
- [4] [ä»è®ºæ–‡åˆ†æï¼Œå‘Šè¯‰ä½ ä»€ä¹ˆå« â€œå¡æ–¹åˆ†ç®±â€ï¼Ÿ](https://toutiao.io/posts/q7i3ki/preview)
- [5] [ChiMerge: Discretization of Numeric Attributes](https://www.aaai.org/Papers/AAAI/1992/AAAI92-019.pdf)
